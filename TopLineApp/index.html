<!DOCTYPE html>

<head>
	<title></title>
	<meta charset="utf-8" />
	<script src="cordova.js"></script>
	<script src="kendo/js/jquery.min.js"></script>
	<script src="kendo/js/kendo.all.min.js"></script>

	<link href="kendo/styles/kendo.common.min.css" rel="stylesheet" />
	<link href="kendo/styles/kendo.default.min.css" rel="stylesheet" />
	<link href="kendo/styles/kendo.mobile.all.min.css" rel="stylesheet" />

	<link href="styles/main.css" rel="stylesheet" />

</head>

<html>

	<body>

		<div id="frmPrincipal" data-role="layout" data-id="mobile-tabstrip">
			<header data-role="header">
				<div data-role="navbar" style="height: 44px;">
					<a href="#" class="nav-button" data-align="right" data-role="button" data-icon="organize"></a>
					<span>Top Line</span>
				</div>
			</header>
			<div data-role="footer">
				<div data-role="tabstrip">
					<a href="#vdentroFila" data-icon="reply">Dentro</a>
					<a href="#vforaFila" data-icon="action">Fora</a>
					<a href="#vforaTurno" data-icon="recents">Turno</a>
				</div>
			</div>
		</div>

		<div id="vdentroFila" data-role="view" data-model="viewModel" data-title="Fila da Vez" data-layout="mobile-tabstrip" data-init="getVendedoresFila" data-show="getVendedoresFila" >
			<div style="text-align:center;">Dentro da Fila</div>
			<ul id="ldentroFila" data-bind="source:dsVendFila" data-role="listview" data-auto-bind="false" data-style="inset" data-template="tdentroFila" class="mobile-fila" data-type="group"></ul>

			<ul id="actAcaoVendedorFila" data-role="actionsheet" data-cancel="Cancelar">
				<li class="km-actionsheet-title">Selecione operação:</li>
				<li>
					<a data-action="atendimento" data-icon="add">Resultado Atendimento</a>
				</li>
				<li>
					<a data-action="showMotivosSaidaFila">Sair fila da Vez</a>
				</li>
			</ul>

		</div>

		<div id="vforaFila" data-role="view"  data-model="viewModel" data-title="Fora da Fila" data-layout="mobile-tabstrip" data-init="getVendedoresForaFila" data-show="getVendedoresForaFila">
			<div style="text-align:center;">Fora da Fila</div>
			<ul  id="lforaFila" data-bind="source:dsVendForaFila" data-role="listview" data-auto-bind="false" data-style="inset" data-template="tforaFila" class="mobile-fila"></ul>
		</div>

		<div id="vforaTurno" data-role="view"  data-model="viewModel" data-title="Outros turnos" data-layout="mobile-tabstrip" data-init="getVendedoresForaExpediente" data-show="getVendedoresForaExpediente">
			<div style="text-align:center;">Fora do Turno</div>
			<ul id="lforaTuarno" data-bind="source:dsVendForaExp" data-role="listview" data-auto-bind="false" data-style="inset" data-template="tforaTurno" class="mobile-fila"></ul>
		</div>

		<div id="resultadoAtendimento" data-init="editorViewInit" data-role="view" data-title="Resultado Atendimento" data-layout="default" data-model="viewModel" >
			<div data-role="header">
				<div data-role="navbar">
					<span>Atendimento</span>
				</div>
			</div>
			<ul id="form" data-role="listview" data-style="inset" data-type="group">

				<li>
					<ul>
						<li>
							<label>
								Vendedor
								<input id="idVendedor" name="idVendedor" type="text" required="required" data-bind="value: atendimento.IdVendedor" />
							</label>

						</li>
						<li>
							<label>
								Vendedor2 <span data-bind="text: vendedorSelecionado.vendedorNome"/>
							</label>

						</li>

					</ul>
				</li>

				<li >

					<ul>
						<li>
							<label>
								Vendeu
								<input id="chkVendeu" type="checkbox" data-role="switch" checked >
							</label>
						</li>
					</ul>
				</li>

				<li>
					Dados da Venda
					<ul>

						<li>
							<label>
								Valor Venda
								<input id="valorVenda" name="ValorVenda" type="number" required="required" data-bind="value: atendimento.ValorVenda" />
							</label>
						</li>
						<li>
							<label>
								Qtde de Peças
								<input id="qtdeDePecas" name="QtdeDePecas" type="number" required="required" data-bind="value: atendimento.QtdeDePecas"/>
							</label>
						</li>

					</ul>

				</li>

			</ul>
			<a id="btnCreate" data-role="button" type="button" data-bind="events: {click: salvarAtendimento}">Salvar</a>
			<a id="btnCancel" data-role="button" type="button" data-bind="events: {click: cancelarAtendimento}">Cancelar</a>
		</div>

		<script type="text/x-kendo-template" id="tdentroFila">
			<a data-rel="actionsheet" href="\\#actAcaoVendedorFila" data-actionsheet-context="#= IdVendedor #">
				<img src="${Foto}" />
				<h5>${VendedorApelido}</h5>
			</a>
		</script>

		<script type="text/x-kendo-template" id="tforaFila">		
			<a data-rel="modalview" href="\\#modalview-login">
				<img src="${Foto}" />
				<h5>${VendedorApelido}</h5>
			</a>
		</script>

		<script type="text/x-kendo-template" id="tforaTurno">
			<a class="details-link" data-role="listview-link">
				<img src="${Foto}" />
				<h5>${VendedorApelido}</h5>
			</a>
		</script>

		<script>
			
			$(document).ready(function() {
				//Start the mobile application
				app = new kendo.mobile.Application($(document.body), {});
			});
			
			//Url
			var baseUrl = "http://localhost:50000/api";
			
			//schema
			var schemaVendedores = { 
				model: {
					id: "IdVendedor",
					fields: {
						IdVendedor: { editable: false, nullable: false },
						VendedorNome: { editable: false, nullable: false },
						VendedorApelido: { editable: false, nullable: false },
						Fila: { editable: false, nullable: false },           
						Foto: { editable: false, nullable: false }
					} 
				}
			};
			
			//Schema Atendimento
			var schemaAtendimento = { 
				model: {
					id: "IdAtendimento",
					fields:{
						IdAtendimento: { type: "int", validation: { required: true, min: 0} },
						IdVendedor: { type: "int", validation: { required: true, min: 0} },
						ValorVenda: { type: "number", validation: { required: true, min: 0} },						
						QtdeDePecas: { type: "number", validation: { required: true, min: 0} }
					} 
				}
			};
			
			//schemaMotivosSaidaSalao
			var schemaMotivosSaida = { 
				model: {
					id: "idMotivo",
					fields: {
						idMotivo: { editable: false, nullable: false },
						Motivo: { editable: false, nullable: false }
					} 
				}
			};
			
			//dataSource
			var dsVendFila = new kendo.data.DataSource({                    
				transport: {						
					read:  {
						url: baseUrl + "/Vendedor/1",							
						type:"GET",
						contentType: "application/json",
						dataType: "json"
					} 
					,
					update: {
						url:baseUrl + "/Vendedor/1",							
						type:"PUT"
						,contentType:"application/json"
						,dataType: "json"
					},
					destroy: {
						url:baseUrl + "/Vendedor"                            
						,type:"DELETE"
						,contentType:"application/json"   
						,dataType: "json"
					},
					parameterMap: function(data, operation) {
						if (operation !== "read" && data.models) {
							return kendo.stringify([data.models[0]]);
						}
					}                 
				},
				batch: true,
				schema: schemaVendedores,                    
				sort: {
					field:
					"IdVendedor", dir
					: "asc"
				}
			});
			
			//dataSource
			var dsVendForaFila = new kendo.data.DataSource({                    
				transport: {						
					read:  {
						url: baseUrl + "/Vendedor/2",							
						type:"GET"      
						,contentType: "application/json"
						,dataType: "json"
					},
					update: {
						url: baseUrl + "/Vendedor/2",							
						type:"PUT"
						,contentType:"application/json"
						,dataType: "json"
					},
					parameterMap: function(data, operation) {
						if (operation !== "read" && data.models) {
							return kendo.stringify([data.models[0]]);
						}
					}
				},
				batch: true,
				schema: schemaVendedores,					
				sort: { 
					field: 
					"VendedorNome", dir: 
					"asc" 
				}	
			});
			
			//dataSource
			var dsVendForaExp = new kendo.data.DataSource({                    
				transport: {						
					read:  {
						url: baseUrl + "/Vendedor/3",							
						type:"GET"      
						,contentType: "application/json"
						,dataType: "json"
					},
					update: {
						url: baseUrl + "/Vendedor/3",							
						type:"PUT"
						,contentType:"application/json"
						,dataType: "json"
					},
					parameterMap: function(data, operation) {
						if (operation !== "read" && data.models) {
							return kendo.stringify([data.models[0]]);
						}
					}                        
				},             
				batch: true,
				schema: schemaVendedores,
				serverPaging: true,
				sort: { field: "VendedorNome", dir: "asc" }	
			});
			
			//dataSource
			var dsMotivosSaida = new kendo.data.DataSource({                    
				transport: {						
					read:  {
						url: baseUrl + "/Motivos",							
						type:"GET"      
						,contentType: "application/json"
						,dataType: "json"
					},
				},
				batch: true,
				schema: schemaMotivosSaida
			});
			
			//dataSource Atendimento
			var dsAtendimento = new kendo.data.DataSource({                    
				transport: {						
					read:  {
						url: baseUrl + "/Atendimento/1",							
						type:"GET"      
						,contentType: "application/json"
						,dataType: "json"
					},
					create: {
						url:baseUrl + "/Atendimento"													
						,type:"POST"                            
						,contentType:"application/json"
						,dataType: "json" 
					},
					parameterMap: function(data, operation) {
						if (operation !== "read" && data.models) {							
							return kendo.stringify(data.models[0]);
						}
					}
				},
				batch: true,
				schema: schemaAtendimento
			});
			
			
			function atendimento(e) {
				var novoAtendimento = this.dsAtendimento.add(); 
				viewModel.set("atendimento", novoAtendimento); 
				
				var vendedor = viewModel.dsVendFila.get(e.context);
				viewModel.set("vendedorSelecionado", vendedor); 
				
				console.log(viewModel);
				
				app.navigate("#resultadoAtendimento"); 
			}
			
			function salvarAtendimento (e) {
				if (validator.validate()) { //validates the input
					this.dsAtendimento.sync(); 	                
					
					//Atualiza a posicao do vendedor na fila
					var vend = viewModel.vendedorSelecionado;			
					
					this.dsVendFila.remove(vend); 
					this.dsVendFila.sync(); 
					
					getVendedoresFila();
					app.navigate("#vdentroFila");
				}
			}
			
			function cancelarAtendimento() {
				this.dsAtendimento.cancelChanges(); 
				app.navigate("#vdentroFila");                 
			}
			
			function editorViewInit(e) {
				validator = $("#form").kendoValidator({ //initialize the validator
					messages: {
						required: function(input) { //create a custom message function
							input.attr("placeholder", input.attr("name") + " is required");
						}
					}
				}).data("kendoValidator");
			}
			
			var viewModel = kendo.observable({
				dsVendFila: dsVendFila,
				dsVendForaFila: dsVendForaFila,
				dsVendForaExp: dsVendForaExp,
				dsMotivosSaida: dsMotivosSaida,
				dsAtendimento: dsAtendimento,
				vendedorSelecionado: {},
				atendimento: {},
				salvarAtendimento: salvarAtendimento,
				cancelarAtendimento: cancelarAtendimento,
				selectGroup: function(e) {
					this.set("selectedGroup", e.dataItem);
					this.set("peopleSource", new kendo.data.DataSource({
						data: this.get("selectedGroup").People
					}));
					app.navigate("#v2");
				},					
				atualizaFilaNoSalao: function() {
					dsVendFila.options.transport.read.url = baseUrl + "/Vendedor/1";
					dsVendFila.read();        
				},             
				atualizaFilaForaDoSalao: function() {
					dsVendForaFila.options.transport.read.url = baseUrl + "/Vendedor/2";
					dsVendForaFila.read();        
				},
				atualizaFilaForaExpediente: function() {
					dsVendForaExp.options.transport.read.url = baseUrl + "/Vendedor/3";
					dsVendForaExp.read();        
				},	
				atualizaMotivosSaida: function() {
					dsMotivosSaida.options.transport.read.url = baseUrl + "/Motivos";
					dsMotivosSaida.read();        
				}
			});
			
			function atualizaFilaNoSalao(context, parametro) {
				context.options.transport.read.url = baseUrl + "/Vendedor/" + parametro;					
				context.read();
			}
			
			function getVendedoresFila(e) {
				atualizaFilaNoSalao(dsVendFila, 1);
			}
			
			function getVendedoresForaFila(e) {	
				atualizaFilaNoSalao(dsVendForaFila, 2);
			}
			
			function getVendedoresForaExpediente(e) {
				atualizaFilaNoSalao(dsVendForaExp, 3);
			}
			
			function showMotivosSaidaFila() {
				app.navigate("#motivosSaida");			
				dsMotivosSaida.options.transport.read.url = baseUrl + "/Motivos";
				dsMotivosSaida.read(); 
			}
			
			function closeModalViewLogin(e) {
				console.log(e);
			
				$("#modalview-login").kendoMobileModalView("close");
			}
			
            function onClick(){ alert("dadsa");}
			
		
		</script>

	</body>

</html>

